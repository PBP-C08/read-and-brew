{% extends 'tracker_planner.html' %}
{% block title %}Book Tracker & Planner{% endblock %}
{% block content %}
    <input type="hidden" id="book" name="book"> 
    <div class="row row-cols-1 row-cols-md-3 row-cols-sm-2 row-cols-xs-1 g-4">
        <!-- Display all books that can be borrowed -->
    </div>

    <!-- Bootstrap Modal for Tracking -->
    <div class="modal fade" id="trackBookModal" tabindex="-1" aria-labelledby="trackBookModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="trackBookModalLabel">Track This Book</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="trackBookForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="page" class="form-label">Total Pages in the Book:</label>
                            <input type="number" class="form-control" id="page" name="page" required>
                        </div>
                        <div class="mb-3">
                            <label for="progress" class="form-label">Pages You've Read:</label>
                            <input type="number" class="form-control" id="progress" name="progress" required>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label">Status:</label>
                            <input type="text" class="form-control" id="status" name="status" value="in_progress" required>
                        </div>
                    </div>                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Track</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Function to get all books that has been borrowed
        async function getBorrowedBooks() {
            return fetch("{% url 'trackernplanner:show_json_borrowedbooks' %}").then((res) => res.json());
        }

        // Function to display all books that can be borrowed
        async function refreshBooks() {
            document.querySelector(".row").innerHTML = "";
            const books = await getBorrowedBooks();
    
            books.forEach((item, index) => {
                const bookId = item.pk;
                const bookCard = `
                <div class="col-md-4 d-flex align-items-center justify-content-center">
                    <div class="card" style="width: 400px;">
                        <img src="${item.fields.Gambar}" class="card-img-top" alt="Book Image" style="width: 400px; height: 300px;">
                        <div class="card-body text-center">
                            <h5 class="card-title h4 font-weight-bold">${item.fields.Judul}</h5>
                            <p class="card-text italic">Author: ${item.fields.Penulis}</p>
                            <p class="card-text italic">Category: ${item.fields.Kategori}</p>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item larger-text">Rating: ${item.fields.Rating}</li>
                            </ul>
                            <div class="d-grid">
                                <button class="btn btn-success borrow-button" data-book="${bookId}" onclick="showConfirmationModal(this)" id="borrowButton">
                                    Track this Book
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
    
                const row = document.querySelector(".row");
                row.innerHTML += bookCard;
            });
        }
        refreshBooks();

        // Function to show the confirmation modal
        function showConfirmationModal(button) {
            const bookId = button.getAttribute("data-book");
            document.querySelector("#book").value = bookId;
            document.querySelector("#page").value = "";
            document.querySelector("#progress").value = "";
            const trackBookModal = new bootstrap.Modal(document.getElementById("trackBookModal"));
            trackBookModal.show();
        }

        // Function to submit the tracking form using AJAX
        document.querySelector("#trackBookForm").addEventListener("submit", async function (e) {
            e.preventDefault();
            const bookId = document.querySelector("#book").value;
            const page = document.querySelector("#page").value;
            const progress = document.querySelector("#progress").value;
            const status = document.querySelector("#status").value;

            // Send the tracking data to the server using AJAX
            const csrfToken = getCookie("csrftoken"); // You need to implement this function
            const response = await fetch("{% url 'trackernplanner:show_tracker' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    book: bookId,
                    page: page,
                    progress: progress,
                    status: status,
                }),
            });

            if (response.ok) {
                // Handle the response (e.g., show a success message or refresh book list)
                const data = await response.json();
                console.log(data.message);
            } else {
                // Handle errors (e.g., display an error message)
                console.error("Failed to track the book.");
            }

            // Close the modal after submitting
            const trackBookModal = new bootstrap.Modal(document.getElementById("trackBookModal"));
            trackBookModal.hide();

            // Refresh the book list
            refreshBooks();
        });

        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
            return null;
        }
    </script>

    <!-- <div class="container mx-auto mt-8">
        <h2 class="text-2xl font-semibold mb-4">Track a Book</h2>
        <form method="post">
            {% csrf_token %}
            <div class="mb-4">
                <label for="book" class="block text-gray-700 font-semibold">Select a Book:</label>
                <select name="book" id="book" class="w-50 p-2 border rounded-md">
                    {% for book in books %}
                        <option value="{{ book.id }}">{{ book.title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4">
                <label for="page" class="block text-gray-700 font-semibold">Total Pages in the Book:</label>
                <input type="number" name="page" id="page" class="w-50 p-2 border rounded-md" required>
            </div>
            <div class="mb-4">
                <label for="progress" class="block text-gray-700 font-semibold">Pages You've Read:</label>
                <input type="number" name="progress" id="progress" class="w-50 p-2 border rounded-md" required>
            </div>
            <button type="submit" class="px-4 py-2 bg-teal-500 text-white font-semibold rounded-md hover:bg-teal-700">Track Your Book</button>
        </form>
    </div> -->
{% endblock content %}