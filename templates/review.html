{% load static %}
<!doctype html>

<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha384-KyZXEAg3QhqLMpG8r+J4jsl5c9zdLKaUk5Ae5f5b1bw6AUn5f5v8FZJoMxm6f5cH1" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <title>{% block title %}{% endblock %} | Read and Brew</title>
    </head>

    <body>
        <nav class="py-6 px-6 flex justify-between items-center border-b border-gray-200">
            <a href="/" class="text-xl font-semibold">Read and Brew</a>

            <div class="space-x-6">
                {% if user.is_authenticated %}      
                    <a onclick="refreshBookHistory()" class="text-xl font-semibold hover:text-gray-500" data-bs-toggle="modal" data-bs-target="#exampleModal">Write A Review</a>
                    <a onclick="refreshReviews()" class="text-xl font-semibold hover:text-gray-500">Their Reviews</a>
                    <a onclick="refreshMyReviews()" class="text-xl font-semibold hover:text-gray-500">Your Reviews</a>
                {% else %}
                    <a href="{% url 'main:login' %}" class="text-xl font-semibold hover:text-gray-500">+ Add a Review</a>
                {% endif %}
                {% if user.is_authenticated %}        
                    <a class="text-lg text-teal-500 font-semibold">Hi, {{ user.username }}!</a>
                    <a href="{% url 'main:logout' %}" class="px-6 py-3 text-lg font-semibold bg-red-500 text-white rounded-xl hover:bg-red-700">Logout</a>
                {% else %}
                    <a href="{% url 'main:signup' %}" class="px-6 py-3 text-lg font-semibold bg-teal-500 text-white rounded-xl hover:bg-teal-700">Sign up</a>
                    <a href="{% url 'main:login' %}" class="px-6 py-3 text-lg font-semibold bg-gray-500 text-white rounded-xl hover:bg-gray-700">Log in</a>
                {% endif %}
            </div>
        </nav>

        <div class="modal fade" id="exampleModal" role="dialog" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Add A Review</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="form" onsubmit="return false;">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="name" class="col-form-label">Username:</label>
                                <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}"></input>
                            </div>
                            <div class="mb-3">
                                <label for="name" class="col-form-label">Book Name:</label>
                                <select name="book_name" id="book_name" class="form-control"></select>
                            </div>
                            <div class="mb-3">
                                <label for="amount" class="col-form-label">Rating:</label>
                                <select type="number" class="form-control" id="rating" name="rating"></select>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="col-form-label">Comment:</label>
                                <textarea class="form-control" id="review" name="review"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="button_add" data-bs-dismiss="modal">Create Review</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="px-6 py-6">
            {% block content %}
            {% endblock %}
        </div>

        <footer class="py-6 px-6 flex justify-between bg-gray-800">
            <div class="w-2/3 pr-10">
                <h3 class="mb-5 font-semibold text-gray-400">About</h3>

                <p class="text-lg text-gray-500">Read & Brew merupakan sebuah tempat yang memadukan kegemaran akan buku dengan kenyamanan sebuah kafe. Kami memiilih kafe sebagai sarana untuk meningkatkan tingkat literasi karena adanya peningkatan yang signifikan terkait dengan tingkat pengunjung kafe di kalangan anak muda. Kami memiliki harapan bahwa kafe tidak hanya bisa menjadi tempat untuk bersantai, tetapi juga menjadi sarana untuk meningkatkan literasi dari kalangan muda yang mayoritasnya masih memiliki tingkat literasi yang rendah.</p>
            </div>

            <div class="w-1/3">
                <h3 class="mb-5 font-semibold text-gray-400">Menu</h3>

                <ul class="space-y-2">
                    <li><a href="#" class="text-lg text-teal-500 hover:text-teal-700">About</a></li>
                    <li><a href="#" class="text-lg text-teal-500 hover:text-teal-700">Contact</a></li>
                    <li><a href="#" class="text-lg text-teal-500 hover:text-teal-700">Privacy policy</a></li>
                    <li><a href="#" class="text-lg text-teal-500 hover:text-teal-700">Term of use</a></li>
                </ul>
            </div>
        </footer>
    </body>
    
    <script>
        async function getReview() {
            return fetch("{% url 'reviewmodul:get_review_json' %}").then((res) => res.json())
        }
        async function refreshReviews() {
            document.getElementById("heading-review").innerHTML = ""
            let heading = `<span>Reviews</span>
                        <h1>Their Reviews</h1>`
            document.getElementById("heading-review").innerHTML = heading

            document.getElementById("reviews-box-container1").innerHTML = ""
            const products = await getReview()
            let htmlString = `{% for name, details in list_review.items %}
                                <div class="reviews-box">
                                    <div class="box-top">
                                        <div class="profile">
                                            <div class="username">
                                                <strong>{{ name }}</strong>
                                                <span>{{ details.book_name }}</span>
                                            </div>
                                        </div>
                                        <div class="rating">{{ details.rating }}/5</div>
                                    </div>
                                    <div class="comment">
                                        <p>{{ details.review }}</p>
                                    </div>
                                </div>
                            {% endfor %}`

            products.forEach((item) => {
                htmlString += `\n<div class="reviews-box">
                                    <div class="box-top">
                                        <div class="profile">
                                            <div class="username">
                                                <strong>${item.fields.username}</strong>
                                                <span>${item.fields.book_name}</span>
                                            </div>
                                        </div>
                                        <div class="rating">${item.fields.rating}/5</div>
                                    </div>
                                    <div class="comment">
                                        <p>${item.fields.review}</p>
                                    </div>
                                </div>`
            })
            document.getElementById("reviews-box-container1").innerHTML = htmlString
        }
        refreshReviews()
    
        function addReview() {
            fetch("{% url 'reviewmodul:add_review_ajax' %}", {
                method: "POST",
                body: new FormData(document.querySelector('#form'))
            }).then(refreshReviews).then(refreshMyReviews)
    
            document.getElementById("form").reset()
            
            return false
        }
        document.getElementById("button_add").onclick = addReview

        async function getReviewMember() {
            return fetch("{% url 'reviewmodul:get_review_json_member' %}").then((res) => res.json())
        }
        async function refreshMyReviews(){
            document.getElementById("heading-review").innerHTML = ""
            let heading = `<span>Reviews</span>
                        <h1>Your Reviews</h1>`
            document.getElementById("heading-review").innerHTML = heading
            
            document.getElementById("reviews-box-container1").innerHTML = ""
            const myReview = await getReviewMember()
            let myString = ``
            myReview.forEach((thing)=>{
                myString += `\n<div class="reviews-box">
                                    <div class="box-top">
                                        <div class="profile">
                                            <div class="username">
                                                <strong>${thing.fields.username}</strong>
                                                <span>${thing.fields.book_name}</span>
                                            </div>
                                        </div>
                                        <div class="rating">${thing.fields.rating}/5</div>
                                    </div>
                                    <div class="comment">
                                        <p>${thing.fields.review}</p>
                                    </div>
                                    <div class="button">
                                        <span class="material-symbols-outlined" onclick="deleteReview(${thing.pk})">delete</span>
                                    </div>
                                </div>`
            })
            document.getElementById("reviews-box-container1").innerHTML = myString
        }
        refreshMyReview()

        async function getBooks(){
            return fetch("{% url 'booklist:get_books' %}").then((res) => res.json())
        }

        async function getHistory() {
            return fetch("{% url 'reviewmodul:get_borrowed_history_json_member' %}").then((res) => res.json())
        }

        async function refreshBookHistory(){
            document.getElementById("book_name").innerHTML=""
            let history = ``
            const books = await getBooks()
            const dataHistory = await getHistory()
            // const currentId = "{{ current_user_id }}"

            const userBorrowedBooks = books.filter((item, index) => {
                const bookId = item.pk;
                return dataHistory.some(book => book.fields.book == bookId);
            });

            if(userBorrowedBooks.length == 0){
                history+=`<option selected="selected" disabled="disabled">--You Haven't Read/Borrow Any Books--</option>`
                
            } else {
                history+=`<option selected="selected" disabled="disabled">--Select Books--</option>`
                books.forEach((item, index) => {
                    const bookId = item.pk
                    const isBorrowed = dataHistory.some(book => book.fields.book == bookId)
                    if (isBorrowed){
                        history+=`<option value="${item.fields.Judul}">${item.fields.Judul}</option>`
                    }
                })
            }
            document.getElementById("book_name").innerHTML=history
            document.getElementById("rating").innerHTML=""
            let rating = `<option value="" selected="selected" name="default" disabled>--Rating--</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>`
            document.getElementById("rating").innerHTML=rating              
        }
        refreshBookHistory()

        function deleteReview(id){
            fetch(`delete_review/${id}`,{
                method: "DELETE",
            }).then(refreshReviews).then(refreshMyReviews)
            return false
        }
    </script>

    <style>
        #main{
            margin: 0px;
            padding: 0px;
            font-family: poppins;
            box-sizing: border-box;
        }
        #reviews{
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            width: 100%;
        }
        .reviews-heading{
            letter-spacing: 1px;
            margin: 30px 0px;
            padding: 10 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .reviews-heading h1{
            font-size: 2rem;
            font-weight: 500;
        }
        .reviews-heading span{
            font-size: 1.3rem;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        .reviews-box-container{
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
        }
        .reviews-box{
            width: 500px;
            box-shadow: 2px 2px 30px rgba(0,0,0,0,1);
            background-color: #ffffff;
            padding: 20px;
            margin: 15px;
            cursor: pointer;
        }
        .profile{
            display: flex;
            align-items: center;
        }
        .username{
            display: flex;
            flex-direction: column;
        }
        .username strong{
            color: #3d3d3d;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
        }
        .username span{
            color: #979797;
            font-size: 1rem;
        }
        .rating{
            color: #3d3d3d;
            font-size: 1.1rem;
        }
        .button{
            display: flex;
            justify-content: right;
        }
        .box-top{
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .comment{
            font-size: 0.9rem;
            color: #4b4b4b;
        }
    </style>
</html>